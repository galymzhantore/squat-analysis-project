# Squat Analysis

Анализ видео приседаний с подсчётом повторений.

## Идея решения

1. **Детекция позы** — MediaPipe Pose извлекает координаты ключевых точек тела (бедро, колено, лодыжка).

2. **Вычисление угла** — угол в колене вычисляется через `atan2`, что даёт стабильный результат вблизи 0° и 180° (в отличие от скалярного произведения).

3. **Сглаживание сигнала** — применяется EMA для устранения дрожания:

   $$angle = alpha * current + (1 - alpha) * previous$$

    Главный трейдофф ЕМА это между чувствительностью к шуму и latency. Чем выше alpha тем чувствительнее к шуму и тем выше latency. Шум может привести к ошибочному подсчету повторений. Поэтому это гиперпараметр, который можно настроить в зависимости от ситуации.

4. **Подсчёт повторений** — детекция локальных минимумов. Повторение засчитывается когда угол опускается ниже порога и затем поднимается на заданную величину.


## Что произойдет, если человек отвернется или модель потеряет точку колена?

```python
# video_processor.py
landmarks = self.detector.detect(frame_rgb)
if landmarks:
    # обрабатываем
else:
    results.append({"angle": None, "reps": self.counter.rep_count})
```
Если поза потеряна — не падает, записывает `null` и продолжает.

## Установка

```bash
pip install -r requirements.txt
```

## Использование

```bash
python main.py --input video.mp4 --output result.mp4 --json results.json
```

### Параметры

- `--input`, `-i` — входное видео (обязательно)
- `--output`, `-o` — выходное видео с аннотациями
- `--json`, `-j` — файл с результатами по кадрам
- `--side` — какую ногу анализировать: `left` или `right` (по умолчанию `left`)
- `--bottom` — порог угла для нижней точки (по умолчанию 90)
- `--rise` — на сколько градусов должен подняться угол для засчёта повторения (по умолчанию 20)

## Docker

```bash
docker build -t squat-analysis .
docker run -v $(pwd):/app squat-analysis --input /app/video.mp4 --output /app/output.mp4
```

## Тесты

```bash
pytest tests/ -v
```

## Референсы

Видео: https://www.youtube.com/watch?v=txnwoJz-Rno